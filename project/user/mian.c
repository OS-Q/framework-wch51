
#include <string.h>
#include <intrins.h> 
#include <stdio.h>

#include "N76E003.h"
#include "WS281X.h"
#include "SFR_Macro.h"
#include "define.h"
#include "I2C.h"
#include "pwm.h"



#define TH0_INIT        1300 
#define TL0_INIT        1300	//定时器
U8 u8TH0_Tmp,u8TL0_Tmp;
U16 Timflag;
U16 zhuflag;
U8 systatus;
U8 led_flag;
U8 num_2 = 0;

U8 xdata led_eff[88]={0x00,0x00,0xf1,0x00,0x00,0x00 ,0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,0x00,0x00,0xf1,0xff,
0x00 ,0x00,0x00 ,0x00,0x00,0xf1, 0x00, 0x00, 0x00, 0x00 ,0x00, 0x00, 0x00, 0x00, 0x00,0x00,0x00,0xf1, 0x00, 0x00, 0x00, 0xff,
0x00 ,0x00 ,0x00, 0x00, 0x00 ,0x00 ,0x00,0x00,0xf1, 0x00 ,0x00 ,0x00 ,0x00,0x00,0xf1, 0x00, 0x00, 0x00, 0x00 ,0x00, 0x00, 0xff,
0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00, 0x00,0x00 ,0x00, 0x00,0x00,0xf1 ,0x00 ,0x00 ,0x00 ,0x00, 0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0xff};
/*
	U8 xdata led_eff[88]={0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xff,
0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xff,
0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xff,
0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xf1,0xff,};*/

void Timer0_init(void)
{
	TIMER0_MODE1_ENABLE;	
	u8TH0_Tmp = (65536-TH0_INIT)/256;
    u8TL0_Tmp = (65536-TL0_INIT)%256; 
	TH0 = u8TH0_Tmp;
    TL0 = u8TL0_Tmp;	
	set_ET0;                                  
    set_EA;  
	set_TR0;
	
}

void Timer0_ISR (void) interrupt 1 
{
    TH0 = u8TH0_Tmp;
    TL0 = u8TL0_Tmp;    
		Timflag++;
		zhuflag++;
}


void led_task(void)
{
	U8 i;	
/*******************************************************************************
	灯数据发送过来，初始化必要的数据
*******************************************************************************/	
	if( Rxflag == 1)
	{				
		Rxflag = 0;
		systatus = 0;
		Timflag =0;
		i = 0;
		led_flag = 1;
		led_lck = 0;
	}
/*******************************************************************************
	led_flag为1说明没有新的灯数据发送过来，一直执行之前的效果
*******************************************************************************/	
	if(200 <= Timflag && led_flag == 1)
	{
		//WS_frame_asyn(&(data_store+i*21+i));		
		i++;
		if(i>=led_number)
				i=0;
		Timflag = 0;
	}
/*******************************************************************************
	led_lck取值为数据第二位0xf1为灯，0xa1为蜂鸣器，只有灯才把led_flag置1 
*******************************************************************************/	
	if(led_lck == 0xf1 && led_flag == 1 )
	{
		ring_display_clear();										
		led_flag = 0;
	}				
}

void main(void)
{	
	U8 led_i = 0;	
	Set_All_GPIO_Quasi_Mode;
	Timer0_init();
	pwm_init();
	Init_I2C();
	P00_PushPull_Mode;
 	InitialUART0_Timer3(115200);
	set_PI2C;
	set_PI2CH;
	P00 = 1;
	Send_Data_To_UART0(0x00);
	
#if 1
	systatus = 0;
	Timflag = 0;
	while(led_lck!=0xf1)
	{
		if(200 <= Timflag)
		{
				if(led_lck!=0xf1)//begin_flag!=1)
				{		
					WS_frame_asyn(&(led_eff+led_i*21+led_i));		
					led_i++;
					if(led_i>=4)
						led_i=0;
					Timflag = 0;
				}
		}	
		i2c_task();
	}
	ring_display_clear();
#endif
	
	while(1)
	{			
		if(zhuflag>=4)
		{
				i2c_task();	
				zhuflag = 0;
		}
			
	}		
}


/************************ (C) COPYRIGHT Qitas **********************/


